# Promise

- 三种状态
- 状态和 then catch
- 常用 API

先回顾一下 Promise 的基本使用

```js
// 加载图片
function loadImg(src) {
  //pengding
  const p = new Promise((resolve, reject) => {
    // const img = document.createElement('img')
    const img = new Image();
    img.onload = () => {
      resolve(img); //resolved
    };
    img.onerror = () => {
      const err = new Error(`图片加载失败 ${src}`);
      reject(err); //rejected
    };
    img.src = src;
  });
  return p;
}
const url = 'https://img.mukewang.com/5a9fc8070001a82402060220-140-140.jpg';
loadImg(url)
  .then((img) => {
    console.log(img.width);
    return img;
  })
  .then((img) => {
    console.log(img.height);
  })
  .catch((ex) => console.error(ex));
```

## 三种状态

三种状态

- pending 在过程中
- resolved
- rejected

画图表示转换关系，以及转换不可逆
pending-> resolved success
pending -> rejected fail

```js
// 刚定义时，状态默认为 pending
const p1 = new Promise((resolve, reject) => {});

// 执行 resolve() 后，状态变成 resolved
const p2 = new Promise((resolve, reject) => {
  setTimeout(() => {
    resolve();
  });
});

// 执行 reject() 后，状态变成 rejected
const p3 = new Promise((resolve, reject) => {
  console.log('p3');
  setTimeout(() => {
    reject();
  });
});
console.log('p3', p3);
// p3 p3 Promise {<pending>}
```

```js
// 直接返回一个 resolved 状态
Promise.resolve(100);
// 直接返回一个 rejected 状态
Promise.reject('some error');
```

## then 和 catch 对状态的改变

状态变化会触发 then catch —— 这些比较好理解，就不再代码演示了

- pending 不会触发任何 then catch 回调
- 状态变为 resolved 会触发后续的 then 回调
- 状态变为 rejected 会触发后续的 catch 回调

- then 正常返回 resolved 里面有 报错返回 rejected
- catch 正常返回 resolved 里面有报错返回 rejected

---

then catch 会继续返回 Promise ，**此时可能会发生状态变化！！！**

```js
// then() 一般正常返回 resolved 状态的 promise
Promise.resolve().then(() => {
  return 100;
});

// then() 里抛出错误，会返回 rejected 状态的 promise
Promise.resolve().then(() => {
  throw new Error('err');
});

// catch() 不抛出错误，会返回 resolved 状态的 promise
Promise.reject().catch(() => {
  console.error('catch some error');
});

// catch() 抛出错误，会返回 rejected 状态的 promise
Promise.reject().catch(() => {
  console.error('catch some error');
  throw new Error('err');
});
```

看一个综合的例子，即那几个面试题

```js
// 第一题
Promise.resolve()
  .then(() => {
    console.log(1);
  })
  .catch(() => {
    console.log(2);
  })
  .then(() => {
    console.log(3);
  });

// 第二题  虽然是catch返回的结果 但是 状态是resolved的 console.log(3)还是会打印
Promise.resolve()
  .then(() => {
    // 返回 rejected 状态的 promise
    console.log(1);
    throw new Error('erro1');
  })
  .catch(() => {
    // 返回 resolved 状态的 promise
    console.log(2);
  })
  .then(() => {
    console.log(3);
  });

Promise.resolve()
  .then(() => {
    // 返回 rejected 状态的 promise
    console.log(1);
    throw new Error('erro1');
  })
  .catch(() => {
    // 返回 resolved 状态的 promise
    console.log(2);
  })
  .catch(() => {  //注意 这里是catch 所以不会呗执行
    console.log(3);
  });
```
